%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#6366f1',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#818cf8',
    'lineColor': '#94a3b8',
    'background': '#0f172a',
    'mainBkg': '#1e293b',
    'nodeBorder': '#475569',
    'clusterBkg': '#1e293b',
    'clusterBorder': '#475569',
    'titleColor': '#f1f5f9',
    'edgeLabelBackground': '#1e293b'
  }
}}%%

flowchart TB
    subgraph INPUT["<b>üë§ USER INPUT</b>"]
        U[("üë§ User Request<br/><br/>‚Ä¢ origin: Tel Aviv<br/>‚Ä¢ destination: Jerusalem<br/>‚Ä¢ profile: interests, age")]
    end

    subgraph MAPS["<b>üó∫Ô∏è GOOGLE MAPS API</b>"]
        G["üó∫Ô∏è GoogleMapsClient<br/><i>src/services/google_maps.py</i>"]
        R[("üìç Route Object<br/><br/>RoutePoint[]<br/>‚Ä¢ location_name<br/>‚Ä¢ coordinates<br/>‚Ä¢ duration")]
    end

    subgraph SCHEDULER["<b>‚è±Ô∏è SCHEDULER</b>"]
        S["‚è±Ô∏è TravelSimulator<br/><i>src/core/timer_scheduler.py</i>"]
        LOOP{{"üîÑ for point in route.points:<br/>on_point_arrival(point)"}}
    end

    subgraph ORCHESTRATOR["<b>üé≠ ORCHESTRATOR</b>"]
        O["üé≠ PointProcessor<br/><i>src/core/orchestrator.py</i>"]
        TPE["‚ö° ThreadPoolExecutor<br/>max_workers=3"]
    end

    subgraph AGENTS["<b>‚ö° PARALLEL AGENTS</b>"]
        A1["üé¨ VideoAgent<br/><i>video_agent.py</i><br/><br/>YouTube API"]
        A2["üéµ MusicAgent<br/><i>music_agent.py</i><br/><br/>Spotify API"]
        A3["üìñ TextAgent<br/><i>text_agent.py</i><br/><br/>Wikipedia API"]
    end

    subgraph QUEUE["<b>üö¶ SMART QUEUE</b>"]
        SQ["üö¶ SmartAgentQueue<br/><i>src/core/smart_queue.py</i>"]
        ST1["‚úÖ COMPLETE<br/>3/3 agents < 15s"]
        ST2["‚ö†Ô∏è SOFT_DEGRADED<br/>2/3 agents @ 15s"]
        ST3["‚ö° HARD_DEGRADED<br/>1/3 agents @ 30s"]
    end

    subgraph JUDGE["<b>‚öñÔ∏è JUDGE AGENT</b>"]
        J["‚öñÔ∏è JudgeAgent<br/><i>src/agents/judge_agent.py</i>"]
        TS["üé∞ Thompson Sampling<br/>Adaptive Selection"]
        SH["üìä SHAP Values<br/>Explainability"]
    end

    subgraph COLLECTOR["<b>üì• RESULT COLLECTOR</b>"]
        C["üì• ResultCollector<br/><i>src/core/collector.py</i>"]
        OUT[("üéâ TourGuideOutput<br/><br/>Personalized Playlist<br/>per RoutePoint")]
    end

    %% Flow connections with numbered steps
    U -->|"1Ô∏è‚É£ Request"| G
    G -->|"2Ô∏è‚É£ Fetch Route"| R
    R -->|"3Ô∏è‚É£ Route Object"| S
    S -->|"4Ô∏è‚É£ Initialize Loop"| LOOP
    LOOP -->|"5Ô∏è‚É£ on_point_arrival()"| O
    O -->|"6Ô∏è‚É£ Spawn Parallel"| TPE
    TPE -->|"7Ô∏è‚É£a"| A1
    TPE -->|"7Ô∏è‚É£b"| A2
    TPE -->|"7Ô∏è‚É£c"| A3
    A1 -->|"8Ô∏è‚É£ ContentResult"| SQ
    A2 -->|"8Ô∏è‚É£ ContentResult"| SQ
    A3 -->|"8Ô∏è‚É£ ContentResult"| SQ
    SQ --> ST1
    SQ --> ST2
    SQ --> ST3
    ST1 -->|"9Ô∏è‚É£"| J
    ST2 -->|"9Ô∏è‚É£"| J
    ST3 -->|"9Ô∏è‚É£"| J
    J --> TS
    J --> SH
    TS -->|"üîü Decision"| C
    SH -->|"üîü Reasoning"| C
    C -->|"1Ô∏è‚É£1Ô∏è‚É£ Store"| OUT
    OUT -.->|"1Ô∏è‚É£2Ô∏è‚É£ Next Point"| LOOP
    LOOP -->|"1Ô∏è‚É£3Ô∏è‚É£ Complete"| U

    %% Professional color scheme - Dark theme with vibrant accents
    style INPUT fill:#312e81,stroke:#6366f1,stroke-width:3px,color:#fff
    style MAPS fill:#4c1d95,stroke:#8b5cf6,stroke-width:3px,color:#fff
    style SCHEDULER fill:#831843,stroke:#ec4899,stroke-width:3px,color:#fff
    style ORCHESTRATOR fill:#7c2d12,stroke:#f97316,stroke-width:3px,color:#fff
    style AGENTS fill:#1e3a5f,stroke:#38bdf8,stroke-width:3px,color:#fff
    style QUEUE fill:#134e4a,stroke:#14b8a6,stroke-width:3px,color:#fff
    style JUDGE fill:#164e63,stroke:#06b6d4,stroke-width:3px,color:#fff
    style COLLECTOR fill:#1e3a8a,stroke:#3b82f6,stroke-width:3px,color:#fff
    
    %% Node styling
    style U fill:#6366f1,stroke:#a5b4fc,stroke-width:2px,color:#fff
    style G fill:#8b5cf6,stroke:#c4b5fd,stroke-width:2px,color:#fff
    style R fill:#a855f7,stroke:#d8b4fe,stroke-width:2px,color:#fff
    style S fill:#ec4899,stroke:#f9a8d4,stroke-width:2px,color:#fff
    style LOOP fill:#f472b6,stroke:#fbcfe8,stroke-width:2px,color:#1f2937
    style O fill:#f97316,stroke:#fdba74,stroke-width:2px,color:#fff
    style TPE fill:#fb923c,stroke:#fed7aa,stroke-width:2px,color:#1f2937
    style A1 fill:#ef4444,stroke:#fca5a5,stroke-width:2px,color:#fff
    style A2 fill:#eab308,stroke:#fde047,stroke-width:2px,color:#1f2937
    style A3 fill:#22c55e,stroke:#86efac,stroke-width:2px,color:#fff
    style SQ fill:#14b8a6,stroke:#5eead4,stroke-width:2px,color:#fff
    style ST1 fill:#10b981,stroke:#6ee7b7,stroke-width:2px,color:#fff
    style ST2 fill:#f59e0b,stroke:#fcd34d,stroke-width:2px,color:#1f2937
    style ST3 fill:#ef4444,stroke:#fca5a5,stroke-width:2px,color:#fff
    style J fill:#06b6d4,stroke:#67e8f9,stroke-width:2px,color:#fff
    style TS fill:#0891b2,stroke:#22d3ee,stroke-width:2px,color:#fff
    style SH fill:#0e7490,stroke:#06b6d4,stroke-width:2px,color:#fff
    style C fill:#3b82f6,stroke:#93c5fd,stroke-width:2px,color:#fff
    style OUT fill:#2563eb,stroke:#60a5fa,stroke-width:2px,color:#fff
