%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#6366f1',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#a5b4fc',
    'lineColor': '#818cf8',
    'secondaryColor': '#ec4899',
    'tertiaryColor': '#14b8a6',
    'actorBkg': '#312e81',
    'actorBorder': '#818cf8',
    'actorTextColor': '#ffffff',
    'actorLineColor': '#818cf8',
    'signalColor': '#818cf8',
    'signalTextColor': '#ffffff',
    'labelBoxBkgColor': '#1e1b4b',
    'labelBoxBorderColor': '#6366f1',
    'labelTextColor': '#f1f5f9',
    'loopTextColor': '#f1f5f9',
    'noteBkgColor': '#fef3c7',
    'noteTextColor': '#1e293b',
    'noteBorderColor': '#f59e0b',
    'activationBkgColor': '#4c1d95',
    'activationBorderColor': '#a78bfa',
    'sequenceNumberColor': '#ffffff',
    'background': '#0f172a',
    'fontFamily': 'SF Pro Display, Inter, system-ui'
  }
}}%%

sequenceDiagram
    autonumber
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% MIT MULTI-AGENT TOUR GUIDE - SEQUENCE DIAGRAM
    %% Complete Flow: User â†’ Maps â†’ Scheduler â†’ Orchestrator â†’ Agents
    %%                â†’ Smart Queue â†’ Judge â†’ Collector â†’ Output
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    participant U as ğŸ‘¤ User
    participant G as ğŸ—ºï¸ Google Maps<br/>GoogleMapsClient
    participant S as â±ï¸ Scheduler<br/>TravelSimulator
    participant O as ğŸ­ Orchestrator<br/>PointProcessor
    participant V as ğŸ¬ Video<br/>Agent
    participant M as ğŸµ Music<br/>Agent
    participant T as ğŸ“– Text<br/>Agent
    participant Q as ğŸš¦ Smart<br/>Queue
    participant J as âš–ï¸ Judge<br/>Agent
    participant C as ğŸ“¥ Collector

    rect rgba(49, 46, 129, 0.8)
        Note over U,C: ğŸ“¥ PHASE 1: ROUTE INITIALIZATION
        U->>+G: get_route(origin, destination)
        G->>G: Fetch waypoints
        G-->>-U: Route with RoutePoint[]
    end

    rect rgba(76, 29, 149, 0.8)
        Note over U,C: â±ï¸ PHASE 2: SCHEDULER INITIALIZATION
        U->>+S: TravelSimulator(route, callback)
        S->>S: Set on_point_arrival()
        U->>S: start()
        Note right of S: Scheduler controls<br/>entire tour pacing
    end

    rect rgba(131, 24, 67, 0.8)
        Note over U,C: ğŸ”„ PHASE 3: POINT PROCESSING LOOP
        
        loop For each point in route.points
            
            rect rgba(157, 23, 77, 0.6)
                S->>+O: on_point_arrival(point)
                Note right of S: Scheduler triggers<br/>Orchestrator
                O->>O: ThreadPoolExecutor(3)
            end

            rect rgba(190, 24, 93, 0.6)
                Note over V,T: âš¡ PARALLEL EXECUTION
                par Video Agent
                    O->>+V: execute(point)
                    V->>V: YouTube Search
                    V-->>-Q: ContentResult
                and Music Agent
                    O->>+M: execute(point)
                    M->>M: Spotify Search
                    M-->>-Q: ContentResult
                and Text Agent
                    O->>+T: execute(point)
                    T->>T: Wikipedia Search
                    T-->>-Q: ContentResult
                end
            end

            rect rgba(20, 184, 166, 0.6)
                Note over Q,Q: ğŸš¦ GRACEFUL DEGRADATION
                Q->>Q: Wait with timeouts
                alt âœ… 3/3 Complete < 15s
                    Q->>Q: COMPLETE
                else âš ï¸ 2/3 @ 15s timeout
                    Q->>Q: SOFT_DEGRADED
                else âš¡ 1/3 @ 30s timeout
                    Q->>Q: HARD_DEGRADED
                end
                Q-->>O: results[], status
            end

            rect rgba(6, 182, 212, 0.6)
                Note over J,J: âš–ï¸ JUDGE EVALUATION
                O->>+J: evaluate(results, profile)
                J->>J: Thompson Sampling
                J->>J: SHAP Explanation
                J-->>-O: JudgeDecision
            end

            rect rgba(59, 130, 246, 0.6)
                Note over C,C: ğŸ“¥ COLLECT DECISION
                O->>+C: add_decision(decision)
                C->>C: Store for point
                C-->>-O: ack
            end

            O-->>-S: point_complete
            S->>S: sleep(interval)
        end
    end

    rect rgba(30, 58, 138, 0.8)
        Note over U,C: ğŸ‰ PHASE 4: FINAL OUTPUT
        S-->>U: tour_complete
        U->>+C: get_output()
        C->>C: Build TourGuideOutput
        C-->>-U: Personalized Playlist
    end
